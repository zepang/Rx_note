jQuery.uaMatch=function(e){e=e.toLowerCase();var r=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:r[1]||"",version:r[2]||"0"}};jQuery.browser||(matched=jQuery.uaMatch(navigator.userAgent),browser={},matched.browser&&(browser[matched.browser]=!0,browser.version=matched.version),browser.chrome?browser.webkit=!0:browser.webkit&&(browser.safari=!0),jQuery.browser=browser),function($){ChiliBook={version:"2.2",automatic:!1,automaticSelector:"code",lineNumbers:!1,codeLanguage:function(el){var recipeName=$(el).attr("class");return recipeName?recipeName:""},recipeLoading:!0,recipeFolder:"",replaceSpace:"&#160;",replaceTab:"&#160;&#160;&#160;&#160;",replaceNewLine:"&#160;<br/>",selectionStyle:"position:absolute; z-index:3000; overflow:scroll; width:16em; height:9em; border:1px solid gray; padding:15px; background-color:yellow;",defaultReplacement:'<span class="$0">$$<\/span>',recipes:{},queue:{},unique:function(){return(new Date).valueOf()}};$.fn.chili=function(options){function cook(ingredients,recipe,blockName){function prepareBlock(recipe,blockName){var steps=[],stepName;for(stepName in recipe[blockName])steps.push(prepareStep(recipe,blockName,stepName));return steps}function prepareStep(recipe,blockName,stepName){var step=recipe[blockName][stepName],exp=typeof step._match=="string"?step._match:step._match.source;return{recipe:recipe,blockName:blockName,stepName:stepName,exp:"("+exp+")",length:1+(exp.replace(/\\./g,"%").replace(/\[.*?\]/g,"%").match(/\((?!\?)/g)||[]).length,replacement:step._replace?step._replace:book.defaultReplacement}}function knowHow(steps){for(var prevLength=1,exps=[],exp,i=0;i<steps.length;i++)exp=steps[i].exp,exp=exp.replace(/\\\\|\\(\d+)/g,function(m,aNum){return aNum?"\\"+(prevLength+1+parseInt(aNum,10)):m}),exps.push(exp),prevLength+=steps[i].length;var prolog="((?:\\s|\\S)*?)",epilog="((?:\\s|\\S)+)",source="(?:"+exps.join("|")+")";return source=prolog+source+"|"+epilog,new RegExp(source,recipe._case?"g":"gi")}function escapeHTML(str){return str.replace(/&/g,"&amp;").replace(/</g,"&lt;")}function replaceSpaces(str){return str.replace(/ +/g,function(spaces){return spaces.replace(/ /g,replaceSpace)})}function filter(str){return str=escapeHTML(str),replaceSpace&&(str=replaceSpaces(str)),str}function applyRecipe(subject,recipe){return cook(subject,recipe)}function applyBlock(subject,recipe,blockName){return cook(subject,recipe,blockName)}function applyStep(subject,recipe,blockName,stepName){var replaceSpace=book.replaceSpace,step=prepareStep(recipe,blockName,stepName),steps=[step];return subject.replace(knowHow(steps),function(){return chef.apply({steps:steps},arguments)})}function applyModule(subject,module,context){function getRecipe(recipeName){var path=getPath(recipeName),recipe=book.recipes[path];if(!recipe)throw{msg:"recipe not available"};return recipe}var recipe,cue,path;if(!module)return filter(subject);var sub=module.split("/"),recipeName="",blockName="",stepName="";switch(sub.length){case 1:recipeName=sub[0];break;case 2:recipeName=sub[0];blockName=sub[1];break;case 3:recipeName=sub[0];blockName=sub[1];stepName=sub[2];break;default:return filter(subject)}try{if(""==stepName)if(""==blockName){if(""!=recipeName)return recipe=getRecipe(recipeName),applyRecipe(subject,recipe)}else return(recipe=""==recipeName?context.recipe:getRecipe(recipeName),!(blockName in recipe))?filter(subject):applyBlock(subject,recipe,blockName);else return(recipe=""==recipeName?context.recipe:getRecipe(recipeName),""==blockName&&(blockName=context.blockName),!(blockName in recipe))?filter(subject):(stepName in recipe[blockName])?applyStep(subject,recipe,blockName,stepName):filter(subject)}catch(e){if(e.msg&&e.msg=="recipe not available"){if(cue="chili_"+book.unique(),book.recipeLoading){if(path=getPath(recipeName),book.queue[path])book.queue[path].push({cue:cue,subject:subject,module:module,context:context});else try{book.queue[path]=[{cue:cue,subject:subject,module:module,context:context}];$.getJSON(path,function(recipeLoaded){var q,i,iTop,replacement;for(book.recipes[path]=recipeLoaded,q=book.queue[path],i=0,iTop=q.length;i<iTop;i++)replacement=applyModule(q[i].subject,q[i].module,q[i].context),book.replaceTab&&(replacement=replacement.replace(/\t/g,book.replaceTab)),book.replaceNewLine&&(replacement=replacement.replace(/\n/g,book.replaceNewLine)),$("#"+q[i].cue).replaceWith(replacement)})}catch(recipeNotAvailable){alert("the recipe for '"+recipeName+"' was not found in '"+path+"'")}return'<span id="'+cue+'">'+filter(subject)+"<\/span>"}return filter(subject)}else return filter(subject)}}function addPrefix(prefix,replacement){return replacement.replace(/(<span\s+class\s*=\s*(["']))((?:(?!__)\w)+\2\s*>)/ig,"$1"+prefix+"__$3")}function chef(){var step,aux,replacement,matches,k,kTop;if(!arguments[0])return"";var steps=this.steps,i=0,j=2,prolog=arguments[1],epilog=arguments[arguments.length-3];if(epilog)return filter(epilog);else while(step=steps[i++])if(aux=arguments,aux[j]){if(replacement="",$.isFunction(step.replacement)){for(matches=[],k=0,kTop=step.length;k<kTop;k++)matches.push(aux[j+k]);matches.push(aux[aux.length-2]);matches.push(aux[aux.length-1]);replacement=step.replacement.apply({x:function(){var subject=arguments[0],module=arguments[1],context={recipe:step.recipe,blockName:step.blockName};return applyModule(subject,module,context)}},matches)}else replacement=step.replacement.replace(/(\\\$)|(?:\$\$)|(?:\$(\d+))/g,function(m,escaped,K){return escaped?"$":K?K=="0"?step.stepName:filter(aux[j+parseInt(K,10)]):filter(aux[j])});return replacement=addPrefix(step.recipe._name,replacement),filter(prolog)+replacement}else j+=step.length}if(blockName||(blockName="_main",checkSpices(recipe)),!(blockName in recipe))return filter(ingredients);var replaceSpace=book.replaceSpace,steps=prepareBlock(recipe,blockName),kh=knowHow(steps);return ingredients.replace(kh,function(){return chef.apply({steps:steps},arguments)})}function loadStylesheetInline(sourceCode){var e,t;document.createElement&&(e=document.createElement("style"),e.type="text/css",e.styleSheet?e.styleSheet.cssText=sourceCode:(t=document.createTextNode(sourceCode),e.appendChild(t)),document.getElementsByTagName("head")[0].appendChild(e))}function checkSpices(recipe){var name=recipe._name,content,blockName,stepName,step,className;if(!book.queue[name]){content=["/* Chili -- "+name+" */"];for(blockName in recipe)if(blockName.search(/^_(?!main\b)/)<0)for(stepName in recipe[blockName])if(step=recipe[blockName][stepName],"_style"in step)if(step._style.constructor==String)content.push("."+name+"__"+stepName+" { "+step._style+" }");else for(className in step._style)content.push("."+name+"__"+className+" { "+step._style[className]+" }");content=content.join("\n");loadStylesheetInline(content);book.queue[name]=!0}}function askDish(el){var recipeName=book.codeLanguage(el),path;if(""!=recipeName)if(path=getPath(recipeName),book.recipeLoading){if(book.queue[path])book.queue[path].push(el);else try{book.queue[path]=[el];$.getJSON(path,function(recipeLoaded){var q,i,iTop;for(book.recipes[path]=recipeLoaded,q=book.queue[path],i=0,iTop=q.length;i<iTop;i++)makeDish(q[i],path)})}catch(recipeNotAvailable){alert("the recipe for '"+recipeName+"' was not found in '"+path+"'")}makeDish(el,path)}else makeDish(el,path)}function makeDish(el,recipePath){var recipe=book.recipes[recipePath],$el,ingredients,dish,start,$pieces,pos;if(recipe&&($el=$(el),ingredients=$el.text(),ingredients)){ingredients=ingredients.replace(/\r\n?/g,"\n");$el.parent().is("pre")&&($.browser.safari||(ingredients=ingredients.replace(/^\n/g,"")));dish=cook(ingredients,recipe);book.replaceTab&&(dish=dish.replace(/\t/g,book.replaceTab));book.replaceNewLine&&(dish=dish.replace(/\n/g,book.replaceNewLine));el.innerHTML=dish;($.browser.msie||$.browser.mozilla)&&enableSelectionHelper(el);var $that=$el.parent(),classes=$that.attr("class"),ln=/ln-(\d+)-([\w][\w\-]*)|ln-(\d+)|ln-/.exec(classes);ln?(addLineNumbers(el),start=0,ln[1]?(start=parseInt(ln[1],10),$pieces=$(".ln-"+ln[1]+"-"+ln[2]),pos=$pieces.index($that[0]),$pieces.slice(0,pos).each(function(){start+=$(this).find("li").length})):start=ln[3]?parseInt(ln[3],10):1,$el.find("ol")[0].start=start,$("body").width($("body").width()-1).width($("body").width()+1)):book.lineNumbers&&addLineNumbers(el)}}function enableSelectionHelper(el){var element=null;$(el).parents().filter("pre").bind("mousedown",function(){element=this;$.browser.msie?document.selection.empty():window.getSelection().removeAllRanges()}).bind("mouseup",function(event){var selected,container_tag,s,r;if(element&&element==this){if(element=null,selected="",$.browser.msie){if(selected=document.selection.createRange().htmlText,""==selected)return;selected=preserveNewLines(selected);container_tag='<textarea style="STYLE">'}else{if(selected=window.getSelection().toString(),""==selected)return;selected=selected.replace(/\r/g,"").replace(/^# ?/g,"").replace(/\n# ?/g,"\n");container_tag='<pre style="STYLE">'}var $container=$(container_tag.replace(/\bSTYLE\b/,ChiliBook.selectionStyle)).appendTo("body").text(selected).attr("id","chili_selection").click(function(){$(this).remove()}),top=event.pageY-Math.round($container.height()/2)+"px",left=event.pageX-Math.round($container.width()/2)+"px";$container.css({top:top,left:left});$.browser.msie?($container[0].focus(),$container[0].select()):(s=window.getSelection(),s.removeAllRanges(),r=document.createRange(),r.selectNodeContents($container[0]),s.addRange(r))}})}function getPath(recipeName){return book.recipeFolder+recipeName+".js"}function getSelectedText(){return $.browser.msie?document.selection.createRange().htmlText:window.getSelection().toString()}function preserveNewLines(html){var newline_flag,text,el;do newline_flag=ChiliBook.unique();while(html.indexOf(newline_flag)>-1);return text="",(/<br/i.test(html)||/<li/i.test(html))&&(/<br/i.test(html)?html=html.replace(/\<br[^>]*?\>/ig,newline_flag):/<li/i.test(html)&&(html=html.replace(/<ol[^>]*?>|<\/ol>|<li[^>]*?>/ig,"").replace(/<\/li>/ig,newline_flag)),el=$("<pre>").appendTo("body").hide()[0],el.innerHTML=html,text=$(el).text().replace(new RegExp(newline_flag,"g"),"\r\n"),$(el).remove()),text}function addLineNumbers(el){function makeListItem1(not_last_line,not_last,last,open){var close=open?"<\/span>":"",aux="";return not_last_line?aux="<li>"+open+not_last+close+"<\/li>":last&&(aux="<li>"+open+last+close+"<\/li>"),aux}function makeListItem2(not_last_line,not_last,last,prev_li){return prev_li?prev_li:makeListItem1(not_last_line,not_last,last,"")}var html=$(el).html(),br=/<br>/.test(html)?"<br>":"<BR>",empty_line="<li>"+book.replaceSpace+"<\/li>",list_items=html.replace(/(<span [^>]+>)((?:(?:&nbsp;|\xA0)<br>)+)(.*?)(<\/span>)/ig,"$2$1$3$4").replace(/(.*?)(<span .*?>)(.*?)(?:<\/span>(?:&nbsp;|\xA0)<br>|<\/span>)/ig,function(all,before,open,content){var pieces,lastPiece;return/<br>/i.test(content)?(pieces=before.split(br),lastPiece=pieces.pop(),before=pieces.join(br),(before?before+br:"")+(lastPiece+content).replace(/((.*?)(?:&nbsp;|\xA0)<br>)|(.*)/ig,function(tmp,not_last_line,not_last,last){return makeListItem1(not_last_line,not_last,last,open)})):all}).replace(/(<li>.*?<\/li>)|((.*?)(?:&nbsp;|\xA0)<br>)|(.+)/ig,function(tmp,prev_li,not_last_line,not_last,last){return makeListItem2(not_last_line,not_last,last,prev_li)}).replace(/<li><\/li>/ig,empty_line);el.innerHTML="<ol>"+list_items+"<\/ol>"}function revealChars(tmp){return $.map(tmp.split(""),function(n,i){return" "+n+" "+n.charCodeAt(0)+" "}).join(" ")}var book=$.extend({},ChiliBook,options||{});return this.each(function(){var $this=$(this);$this.trigger("chili.before_coloring");askDish(this);$this.trigger("chili.after_coloring")}),setTimeout(function(){$("code li").css("display","block").css("display","")},1e3),this}}(jQuery);